apiVersion: v1
kind: ConfigMap
metadata:
  name: casc-jobdsl-seed-config
  namespace: jenkins
data:
  seed.groovy: |
    import org.yaml.snakeyaml.Yaml

    def yaml = new Yaml()

    /*
     * ======================
     * GO PROJECTS
     * ======================
     */
    def goCfg = yaml.load(readFileFromWorkspace('project/go.yaml'))

    goCfg.projects.each { p ->
      pipelineJob("DEVELOPMENT/${p.name}") {
        description("Go service: ${p.name}")

        definition {
          cps {
            sandbox(true)
            script("""
              pipeline {
                agent any
                environment {
                  APP_NAME = '${p.name}'
                  APP_PORT = '${p.port}'
                }
                stages {
                  stage('Checkout') {
                    steps {
                      git '${p.repo}'
                    }
                  }
                  stage('Build') {
                    steps {
                      sh 'go build ./...'
                    }
                  }
                }
              }
            """)
          }
        }
      }
    }

    /*
     * ======================
     * REACT PROJECTS
     * ======================
     */
    def reactCfg = yaml.load(readFileFromWorkspace('project/react.yaml'))

    reactCfg.projects.each { p ->
      pipelineJob("DEVELOPMENT/${p.name}") {
        description("React app: ${p.name}")

        definition {
          cps {
            sandbox(true)
            script("""
              pipeline {
                agent any
                stages {
                  stage('Checkout') {
                    steps {
                      git '${p.repo}'
                    }
                  }
                  stage('Build') {
                    steps {
                      sh 'npm install'
                      sh 'npm run build'
                    }
                  }
                }
              }
            """)
          }
        }
      }
    }
